얼굴 인식은 사람 인식 중에서 가장 많이 연구된 분야
고전 방법에서 가장 성공적인 고유 얼굴eigen face 기법
얼굴 영상에 주성분 분석을 적용하여 차원을 줄인 다음 매칭 알고리즘으로 인식
당시에는 획기적 진전
정면 얼굴에 적용할 수 있는 한계(LFW 데이터셋에서 정확률 95%, 그 이상 돌파 못함)
 컨볼루션 신경망 시대
2014년 AlexNet을 백본으로 사용한 DeepFace는 LFW에서 97.35% 달성하여 사람 수준에 근접
이후 VGGNet을 백본으로 사용한 VGGFace, GoogLeNet을 사용한 FaceNet, Resnet을 사용한 SphereFace 등이 99.8% 달성

얼굴 확인face verification과 얼굴 식별face identification
얼굴 확인은 두 장의 얼굴이 동일인인지 확인하는 문제(예, 공항 여권 검사)
얼굴 식별은 입력 영상을 등록된 영상과 매칭하여 누구인지 알아내는 문제
얼굴 인식은 미세 분류 문제의 일종
손실 함수를 잘 설계하여 성능 향상 모색
같은 부류 영상은 유사도 높게 유지하고 다른 부류는 낮게 유지하는 손실 함수
Contrastive 손실 함수, triplet 손실 함수, center 손실 함수 등이 개발됨

얼굴 확인face verification과 얼굴 식별face identification
얼굴 확인은 두 장의 얼굴이 동일인인지 확인하는 문제(예, 공항 여권 검사)
얼굴 식별은 입력 영상을 등록된 영상과 매칭하여 누구인지 알아내는 문제
얼굴 인식은 미세 분류 문제의 일종
손실 함수를 잘 설계하여 성능 향상 모색
같은 부류 영상은 유사도 높게 유지하고 다른 부류는 낮게 유지하는 손실 함수
Contrastive 손실 함수, triplet 손실 함수, center 손실 함수 등이 개발됨

성별과 나이 추정 데이터셋
MORPH II: 16~77세인 얼굴 영상 55,134장. 인종과 성별 레이블도 있음
IMDB-WIKI: 연예인의 성별과 나이를 레이블링한 50만 장 이상의 영상
AFADAsian Face Age Dtaset: 성별과 나이 레이블을 가진 아시아인 얼굴 영상 16만장 
UTKface: 0~116세에 대해 나이, 성별, 인종을 레이블링한 23,708장의 얼굴 영상

나이 추정은 주로 순서형 회귀ordinal regression 문제로 취급
K-1개의 출력층 각각은 나이가 k 이상인가라는 질문을 책임짐
예라고 답한 출력층의 개수를 예측 나이로 출력

얼굴 인식 기술은 애플의 Face ID 및 코로나 출입 명부 인식기등 굉장히 다양한 분야에 사용되고 있음
크게 3-4가지 분류의 연구들이 이루어지고 있음
얼굴 검출 : 이미지나 영상에서 사람의 얼굴을 찾는 작업
얼굴 인식 : 이미지나 영상에서 개개인의 고유한 얼굴을 인식하는 작업
얼굴 감정인식 : 얼굴 인식된 정보에서 감정인식 분류를 하는 기술
얼굴 정렬 : 최근 애플, 줌 및 메타버스에서 유행하는 얼굴을 캐릭터로 보여주는 작업

성별 인식 [Ng2012], 인종 인식 [Muhammad2012, Lu2004]
표적 광고에 유용

표정 인식
보통 여섯 종류의 표정으로 분류
LBP 특징과 SVM 분류기 사용 [Shan2009]
서베이 논문 [Fasel2003, Bettadapura2012]

모바일 기기
스마트폰, 태블릿 PC, 구글 글래스 등
고해상도 디스플레이, 각종 센서 (카메라, 마이크, 자이로, 가속도, 자기, GPS 등)
고성능 CPU와 GPU
초고속 통신 장비
 컴퓨터 비전과 무슨 관련이 있나?

예) iPhone 5S
CPU: 1.3 GHz 64bit dual core Apple A7
Memory: 1 GB LPDDR3 DRAM
Storage: 64 GB flash memory
Display: 1136 x 640 resolution at 326 ppi
Graphics: PowerVR G6430 (4-core) GPU

구글의 노력
안드로이드4.0의 Face unlock, 고글 앱, 구글 글래스 등
ILSVRC-2012의 우승을 차지한 슈퍼비전 팀의 인수 

증강 현실
실시간으로 물체의 종류와 자세를 알아내어 그에 맞게 합성 영상을 덧씌움
모바일 단말에서 실시간 처리 필수

하르 캐스케이드 얼굴 검출 (Haar Cascade Face Detection)
 'Rapid Object Detection using a Boosted Cascade of Simple Features' 논문(2001년 발표)에서 제안한 객체 검출 알고리즘으로 고전적인 방법임
단, 알고리즘이 다소 간단한 편이어서 공부 및 비교용으로 사용

Haar-features란?
헝가리 수학자 Alfred Haar에 의해 1909년에 발표된 개념으로 CNN의 커널과 비슷한데, 합성곱 연산을 하는건 아니지만, 하는일은 비슷함

1번 에지 검출
2개의 구역으로 반으로 나뉜 사각형을 사용 이미지를 반으로 나누고 각 픽셀을 더하면 둘중 더 밝은 영역 이 나오게 됨
이제 더 밝은 흰색의 영역의 값들에서 어두운색의 값들을 뺌
A-D 와 같이 다양한 형태의 피처들의 모양을 사용하여 다양한 이미지 인식을 할 수 있음
맨 처음 얼굴에서 필터의 흰색 영역에 있는 모든 픽셀 값의 합에서 검은색 영역에 있는 모든 픽셀 값의 합을 빼면 64 -> 흰색이 더 밝다는 의미, Harr 피처가 제대로 반영이 되었다는 뜻
두번째 0인 경우는 해당 필터로 이미지에서 어떠한 특징도 찾지 못함
세번째 애플 로고는 16으로 밝은 쪽을 잘 찾음
네번째 -127이 나오는 경우는 피처가 잘못되었다는 뜻

![alt text](image.png)

필터의 사각형 영역에 포함된 모든 픽셀 값을 다 합해야 하기 때문에 만약에 MXN 의 픽셀을 가진다면 필터 하나당 필터 하나로 하나의 피처 값을 구하려면 (NxM -1) 번 덧셈을 해야함
이게 Harr 피처들의 모든 박스들에서 계산을 해야하기 때문에 시간이 많이 걸리게 됨
통합 이미지
왼쪽이 원본 이미지의 모든 픽셀 값을 뜻함
오른쪽은 간단한 계산으로 구한 통합 이미지의 픽셀 값
통합 이미지를 구하는 방법은 왼쪽 상단을 1행 1열이라고 하면,  첫 번째 원본 이미지에서 1행 1열부터 3행 3열까지 모든 픽셀 값을 합하면 25가 됩니다(5 + 2 + 3 + 1 + 5 + 4 + 2 + 2 + 1 = 25). 그러면 통합 이미지의 3행 3열에 25를 계산
두 번째도 1행 1열부터 4행 3열까지 모든 픽셀 값의 합은 52입니다. 그러면 통합 이미지의 4행 3열에도 52를 기재

![alt text](image-1.png)

이미 덧셈이 완료된 값이 통합 이미지에 저장되어 있기 때문에 NXM-1 번 계산이 아니라 3번만 하면 됨
location 4 - location 2 - location 3 + location 1
p-q-s+r = Intrgral Imaage

하르 피처는 흰색 검정색으로 나뉘어져 있음
그러면 7번의 계산만 수행 하면 됨
Cascade 검출 (종속분류별 검출)
계산 속도를 높이기 위해서 각 단계별로 (사이즈가 다른 Harr Feature)들을 준비해두고 검출을 수행
초반에 단순한 분류기로 활용해 전혀 얼굴이 아닌 이미지를 바로 버림
약간 얼굴과 비슷한 건 첫 번째 분류기를 통과
두 번째 분류기가 조금 더 복잡한 연산을 해서 얼굴인지 아닌지 구분
앞쪽에 있는 분류기는 계산 비용이 작지만 분류 성능이 좋지는 않고, 뒤쪽에 있는 분류기는 계산 비용은 큰데 분류 성능이 좋음
아예 싹이 아닌 걸 초반에 미리 제외해서 계산 시간을 빠르게 하는 원리입니다.
사람의 얼굴은 음영이 지기 때문에 검출 하기가 쉬움 (눈 코 주위가 어둡고, 광대 이마 부분이 밝은 등등)
하르 캐스케이드 얼굴 검출 (Haar Cascade Face Detection)
2-2.ipynb 파일 생성
하스 캐스케이드 얼굴 검출에 대해 미리 트레이닝 해둥 자료는 OpenCV 공식 사이트에 있음 (https://github.com/opencv/opencv/tree/master/data/haarcascades) 
우리 수업에서는 해당 부분을 클래스 룸에 올려 둠
밝은 부분과 어두운 부분의 픽셀값을 빼서 엣지를 검출해서 사람인지 아닌지를 검출 얼굴에 음영이 지기 떄문에 가능한 일

HOG(Histrogram of Gradient) 얼굴 검출
HOG는 대상 영역을 일정 크기의 셀로 분할하고, 각 셀마다 edge 픽셀들의 기울기 벡터 대한 히스토그램을 구한 후 이들 히스토그램 bin 값들을 일렬로 연결한 벡터 (초기에는 보행자 걸음을 측정하기 위해서 사용됨)
히스토그램(histogram)은 표로 되어 있는 도수 분포를 정보 그림으로 나타낸 것
HOG는 edge의 방향 히스토그램 템플릿으로 볼 수 있음
기울기 벡터(Gradient Vectors)
이미지의 경계선(엣지) 부분에 픽셀을 기준으로 하면 주변 픽셀의 밝기를 비교하여 밝은 방향으로 향하는 기울기를 나타내는 벡터를 의미
이런 기울기들을 사용하여 이미지에서 대상을 찾을수 있음 

템플릿 매칭(template matching)의 경우에는 원래 영상의 기하학적 정보를 그대로 유지하며 매칭을 할 수 있지만 대상의 형태나 위치가 조금만 바뀌어도 매칭이 잘 안되는 문제가 있음
히스토그램 매칭은 대상의 형태가 변해도 매칭을 할 수 있지만 대상의 기하학적 정보를 잃어버리고 단지 분포(구성비) 정보만을 기억하기 때문에 잘못된 대상과도 매칭이 되는 문제가 있음
HOG는 템플릿 매칭과 히스토그램 매칭의 중간 단계에 있는 매칭 방법으로 볼 수 있으며 블록 단위로는 기하학적 정보를 유지하되, 각 블록 내부에서는 히스토그램을 사용함으로써 로컬한 변화에는 어느정도 강인한 특성을 가지고 있음! – 이런 부분에 착안하여 얼굴을 찾는데 이용
비슷한 이미지는 비슷한 히스토그램 빈도수를 가짐
즉 사람의 얼굴 이나 보행자의 모습에 대한 히스토그램 빈도수로 매칭을 한다면  (미리 학습해둔 사람의 얼굴 모습 및 보행자의 모습을 인식할 수 있음) – 역시 학습에 시간이 많이걸리고 ML 기법으로 학습을 수행함

얼굴 검출 : 이미지나 영상에서 사람의 얼굴을 찾는 작업
얼굴 인식 : 이미지나 영상에서 개개인의 고유한 얼굴을 인식하는 작업 

LBPH(Local Binary Patterns Histograms)
LBPH는 빠른 계산 속도와 단순한 알고리즘 때문에 얼굴 인식, 자동차 번호판 인식, 환자 진단 및 생체 인증 등에 쓰임
 LBP(Local Binary Patterns)
영상처리 분야에서 텍스처를 인식하거나 분석하는 데 사용하는 특징 추출 기술
이미지의 각 픽셀 주변 픽셀 값을 이진수로 변환해 이미지의 특징을 추출합니다. 이진수는 중심 픽셀과 이웃 픽셀의 상대적인 밝기 차이에 따라 생성됩니다. 이웃 픽셀이 중심 픽셀보다 크면 1, 작으면 0으로 표현
만들어진 이진수를 활용해 각 픽셀의 텍스처 특징을 추출하고 이를 활용해 이미지에서 물체나 얼굴을 인식함

파라미터 설정
Neighbors(이웃 픽셀 수) : LBP를 만들 때 사용할 이웃 픽셀 수를 뜻합니다. 이웃 픽셀 수가 많을수록 계산 비용이 높아짐 일반적으로 8로 설정
Grid X(수평 방향 분할 수) : 수평 방향으로 셀을 분할할 개수(8)
Grid Y(수직 방향 분할 수) : 수직 방향으로 셀을 분할할 개수(8)
 
데이터 준비
인식하려는 사람들로 이루어진 데이터를 활용해서요. 각 얼굴마다 고유한 ID가 있어야 함 

LBP 작업 수행
원본 이미지에서 3x3 픽셀로 이루어진 윈도(window)를 선택 흑백 이미지라서 각 픽셀은 0~255 사이의 값
3x3 픽셀로 이루어진 윈도의 가운데값을 임계값(threshold)으로 정함
이웃 픽셀값을 순회하면서 임계값보다 작으면 0, 크면 1로 값을 설정
임계값인 가운데 값은 빼고 나머지 이웃 셀의 이진 값을 활용해 이진수를 만듦 (왼쪽부터 순서대로 붙이면 10001101) (시계방향으로 해도 됨(10011010)
10001101을 십진수로 바꿉니다. 141이 되고, 가운데 픽셀을 141로 바꿈
이미지의 다른 칸들은 각각 이렇게 계산을 해서 만들어진 LBP 값이라고 보면 됨

히스토그램 만들기
 LBP 이미지를 (Grid X, Grid Y)로 분할 (8X8)
각 그리드별로 픽셀 값의 크기에 따라 히스토그램을 그림 (64개)
64개 히스토그램을 결합해 최종 히스토그램을 생성
최종 히스토그램을 통한 사람 얼굴 판별
히스토그램이 해당 얼굴에 대한 고유한 히스토그램이며 같은 사람이면 비슷한 히스토그램 패턴을 가질것임! (절대값 계산등을 하면 비슷한 히스토그램인지 판단할 수 있음)
단 해당 부분의 구현은 OpenCV (C++로 되어 있기 때문에 우리는 사용하는 형태의 실습 이후 딥러닝 모듈을 붙이는 부분으로 방향을 잡을 예정)
얼굴 인식을 하기 위해서는 다음의 알고리즘을 설계를 해야함
1단계 얼굴 검출을 해서 얼굴을 찾기
2단계 찾은 얼굴 영역에 LBPH 로 학습하기
3단계 학습한 LBHP 파일을 사용하여 검출 하기

LBPH 자체는 OpenCV 에 있기 때문에 이를 활용해서 실습을 실행할 예정임

 
